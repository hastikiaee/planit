<!DOCTYPE html>
{% load static %}
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../static/media/title.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Vazir&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="{% static 'css/student_style.css' %}" rel="stylesheet">
  <title>Ù¾Ù†Ù„ Ø§ØµÙ„ÛŒ Ú†Ø§Ø±Øª Ø¯Ø±ÙˆØ³</title>
</head>
<body>
  <header>
    <img src="../static/media/logo.png" alt="Ù„ÙˆÚ¯Ùˆ" class='logo'>
    <h1>Ù¾Ù†Ù„ Ø§ØµÙ„ÛŒ Ú†Ø§Ø±Øª Ø¯Ø±ÙˆØ³</h1>
  </header>

  <!-- Ø³ÙˆØ¦ÛŒÚ† Ø¯Ø§Ø±Ú© Ù…ÙˆØ¯ -->
  <div class="darkmode">
    <input type="checkbox" class="darkmode-checkbox" id="darkmode" />
    <label class="darkmode-label" for="darkmode">
      <i class="fas fa-moon"></i>
      <i class="fas fa-sun"></i>
      <div class="ball"></div>
    </label>
  </div>

  <!-- Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† Ø¨Ø§Ø± -->
  <nav id="nav">
    {% if full_name %}
      <div class="nav-buttons">
        <form action="{% url 'logout' %}" method="post">
          {% csrf_token %}
          <button type="submit">Ø®Ø±ÙˆØ¬</button>
        </form>
        <button onclick="switchTab('charts')">Ú†Ø§Ø±Øªâ€ŒÙ‡Ø§</button>
        <button onclick="switchTab('conflicts')">ØªØ¯Ø§Ø®Ù„Ø§Øª</button>
        <button onclick="switchTab('communication')">Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª</button>
      </div>
      <p><span class="welcome">Ø³Ù„Ø§Ù… </span>{{ full_name }}<spanid="full_name"></span></p>
    {% else %}
      <div class="nav-buttons">
        <button onclick="switchTab('charts')">Ú†Ø§Ø±Øªâ€ŒÙ‡Ø§</button>
        <button onclick="switchTab('conflicts')">ØªØ¯Ø§Ø®Ù„Ø§Øª</button>
        <button onclick="switchTab('communication')">Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª</button>
      </div>
    {% endif %}
      <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
  </nav>
  <div id="spacer"></div>

  <!-- Ø§Ø³Ù„Ø§ÛŒØ¯ Ø¨Ø§Ø± -->
  <div class="sidebar" id="sidebar">
    <button onclick="showSection('side_schedule')">Ú†Ø§Ø±Øª Ø¯Ø±Ø³ÛŒ</button>
    <button onclick="showSection('side_examination')">Ú†Ø§Ø±Øª Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
    <button onclick="showSection('side_weekly')">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</button>
    <button onclick="showSection('side_changes')">ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø®ÛŒØ±</button>
    <button onclick="showSection('side_confliction')">ØªØ¯Ø§Ø®Ù„Ø§Øª</button>
    <button onclick="showSection('side_messages')">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</button>
  </div>
  
  <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­ØªÙˆØ§ -->
  <div class="container">
    <!-- Ú†Ø§Ø±Øª Ù‡Ø§ -->
    <div id="charts" class="tab-content active">
      <!-- Ø¬Ø¯ÙˆÙ„ Ú†Ø§Ø±Øª Ø¯Ø±ÙˆØ³ -->
      <div id="side_schedule" class="section">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>Ø±ÙˆØ²Ù‡Ø§</th>
              <th>Ú¯Ø±ÙˆÙ‡</th>
              <th>08:00 08:30</th>
              <th>08:30 09:00</th>
              <th>09:00 09:30</th>
              <th>09:30 10:00</th>
              <th>10:00 10:30</th>
              <th>10:30 11:00</th>
              <th>11:00 11:30</th>
              <th>11:30 12:00</th>
              <th>12:00 12:30</th>
              <th>12:30 13:00</th>
              <th>13:00 13:30</th>
              <th>13:30 14:00</th>
              <th>14:00 14:30</th>
              <th>14:30 15:00</th>
              <th>15:00 15:30</th>
              <th>15:30 16:00</th>
              <th>16:00 16:30</th>
              <th>16:30 17:00</th>
              <th>17:00 17:30</th>
              <th>17:30 18:00</th>
            </tr>
            <tr id="empty-schedule-table">              
              <td colspan="22" style="text-align:center; color: black;">!Ù‡Ù†ÙˆØ² Ú†Ø§Ø±Øª Ø¯Ø±ÙˆØ³ Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td>
            </tr>
          </thead>
          <tbody id="schedule-body"></tbody>
        </table>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ú†Ø§Ø±Øª Ø§Ù…ØªØ­Ø§Ù†Ø§Øª -->
      <div id="side_examination" class="section">
        <table class="examination-table" id="examsTable">
          <thead>
              <tr>
                  <th>Ø±ÙˆØ² Ù‡ÙØªÙ‡</th>
                  <th>ØªØ§Ø±ÛŒØ® Ø§Ù…ØªØ­Ø§Ù†</th>
                  <th>Ø²Ù…Ø§Ù† Ø§Ù…ØªØ­Ø§Ù†</th>
                  <th>ÙˆØ±ÙˆØ¯ÛŒ</th>
                  <th>Ø±Ø´ØªÙ‡</th>
                  <th>Ù†Ø§Ù… Ø§Ø³ØªØ§Ø¯</th>
                  <th>Ù†ÙˆØ¹ Ø¯Ø±Ø³</th>
                  <th>Ù†Ø§Ù… Ø¯Ø±Ø³</th>
              </tr>
          </thead>
          <tbody>
            <script>
              class jDate {
                constructor(year, month, day) {
                  this.year = parseInt(year);
                  this.month = parseInt(month);
                  this.day = parseInt(day);
                }
                toGregorian() {
                  let g = jalaliToGregorian(this.year, this.month, this.day);
                  return new Date(g.gy, g.gm - 1, g.gd);
                }
                static fromGregorian(date) {
                  let gYear = date.getFullYear();
                  let gMonth = date.getMonth() + 1;
                  let gDay = date.getDate();
                  let j = gregorianToJalali(gYear, gMonth, gDay);
                  return new jDate(j.jy, j.jm, j.jd);
                }
                addDays(n) {
                  let gDate = this.toGregorian();
                  gDate.setDate(gDate.getDate() + n);
                  return jDate.fromGregorian(gDate);
                }
                isBeforeOrEqual(other) {
                  if(this.year < other.year) return true;
                  if(this.year > other.year) return false;
                  if(this.month < other.month) return true;
                  if(this.month > other.month) return false;
                  return this.day <= other.day;
                }
                toString() {
                  return `${this.year}/${String(this.month).padStart(2,'0')}/${String(this.day).padStart(2,'0')}`;
                }
                getWeekday() {
                  let gDate = this.toGregorian();
                  return gDate.toLocaleDateString('fa-IR', { weekday: 'long' });
                }
              }
              function getExamDates(startStr, endStr) {
                let examDays = [];
            
                function parseJalali(str) {
                  let parts = str.split('/');
                  return new jDate(parts[0], parts[1], parts[2]);
                }
            
                let start = parseJalali(startStr);
                let end = parseJalali(endStr);
            
                let current = start;
                while(current.isBeforeOrEqual(end)) {
                  let weekday = current.getWeekday();
                  if (weekday !== "Ø¬Ù…Ø¹Ù‡") {
                    examDays.push({ day: weekday, date: current.toString() });
                  }
                  current = current.addDays(1);
                }
                return examDays;
              }
              const examTimes = ["09:00-11:00", "09:00-11:00", "13:30-15:30", "13:30-15:30"];
              function renderExamTable() {
                const startDate = document.getElementById('start_date').value.trim();
                const endDate = document.getElementById('end_date').value.trim();
            
                if (!startDate || !endDate) {
                  alert("Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
                  return;
                }
            
                let examDays;
                try {
                  examDays = getExamDates(startDate, endDate);
                } catch {
                  alert("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø´Ú©Ù„ yyyy/mm/dd Ø¨Ø§Ø´Ø¯.");
                  return;
                }
            
                const tbody = document.querySelector("#examsTable tbody");
                tbody.innerHTML = ""; 
            
                examDays.forEach(({ day, date }) => {
                  examTimes.forEach((time, index) => {
                    const tr = document.createElement('tr');
                    if(index === 0) {
                      const tdDay = document.createElement('td');
                      tdDay.rowSpan = 4;
                      tdDay.textContent = day;
                      tr.appendChild(tdDay);
            
                      const tdDate = document.createElement('td');
                      tdDate.rowSpan = 4;
                      tdDate.textContent = date;
                      tr.appendChild(tdDate);
                    }
            
                    const tdTime = document.createElement('td');
                    tdTime.textContent = time;
                    tr.appendChild(tdTime);
            
                    for(let i=0; i<5; i++) {
                      const tdEmpty = document.createElement('td');
                      tr.appendChild(tdEmpty);
                    }
            
                    tbody.appendChild(tr);
                  });
                });
              }
              renderExamTable();
            </script>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ -->
    <div id="side_weekly" class="section">
      <table class="schedule-table" border="1">
        <thead>
          <tr>
            <th>Ø±ÙˆØ²Ù‡Ø§</th>
            <th>08:00 08:30</th>
            <th>08:30 09:00</th>
            <th>09:00 09:30</th>
            <th>09:30 10:00</th>
            <th>10:00 10:30</th>
            <th>10:30 11:00</th>
            <th>11:00 11:30</th>
            <th>11:30 12:00</th>
            <th>12:00 12:30</th>
            <th>12:30 13:00</th>
            <th>13:00 13:30</th>
            <th>13:30 14:00</th>
            <th>14:00 14:30</th>
            <th>14:30 15:00</th>
            <th>15:00 15:30</th>
            <th>15:30 16:00</th>
            <th>16:00 16:30</th>
            <th>16:30 17:00</th>
            <th>17:00 17:30</th>
            <th>17:30 18:00</th>
          </tr>
        </thead>
        <tbody id="weekly-schedule-body"></tbody>
      </table>
    </div>

    <!-- ØªØ¯Ø§Ø®Ù„Ø§Øª -->
    <div id="conflicts" class="tab-content">
      <!-- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ¯Ø§Ø®Ù„Ø§Øª -->
      <div id="side_confliction" class="section">
        <!-- Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ¯Ø§Ø®Ù„Ø§Øª -->
        <div class="add-conflict-box">
          <h3>Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ¯Ø§Ø®Ù„</h3>
          <div class="form-section">
            <!-- ØªØ¯Ø§Ø®Ù„ Ø¯Ø±Ø³ ÛŒØ§ Ø§Ù…ØªØ­Ø§Ù† -->
            <div>
              <label for="conflict_type">:Ù†ÙˆØ¹ ØªØ¯Ø§Ø®Ù„</label>
              <select id="conflict_type" class="time-box">
                  <option value="Ø¯Ø±Ø³">Ø¯Ø±Ø³</option>
                  <option value="Ø§Ù…ØªØ­Ø§Ù†">Ø§Ù…ØªØ­Ø§Ù†</option>
              </select>
            </div>
            <!-- Ø±ÙˆØ² ØªØ¯Ø§Ø®Ù„ -->
            <div>
              <label for="conflict_days">:Ø±ÙˆØ² ØªØ¯Ø§Ø®Ù„</label>
              <select id="conflict_days" class="time-box">
                <option value="Ø´Ù†Ø¨Ù‡">Ø´Ù†Ø¨Ù‡</option>
                <option value="ÛŒÚ©Ø´Ù†Ø¨Ù‡">ÛŒÚ©Ø´Ù†Ø¨Ù‡</option>
                <option value="Ø¯ÙˆØ´Ù†Ø¨Ù‡">Ø¯ÙˆØ´Ù†Ø¨Ù‡</option>
                <option value="Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</option>
                <option value="Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</option>
                <option value="Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡">Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡</option>
                <option value="Ù‡Ø± Ø¯ÙˆØ±ÙˆØ²">Ù‡Ø± Ø¯Ùˆ Ø±ÙˆØ²</option>
            </select>
            </div>
            <!-- Ø¯Ø±Ø³ Ø¯ÙˆÙ… -->
            <div>
              <label for="conflict_subject_two">:Ø¯Ø±Ø³ Ø¯ÙˆÙ…</label>
              <select id="conflict_subject_two" class="time-box">
                {% for subject in subject_list %}
                  <option value="{{ subject }}">{{ subject }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- Ø¯Ø±Ø³ Ø§ÙˆÙ„ -->
            <div>
              <label for="conflict_subject_one">:Ø¯Ø±Ø³ Ø§ÙˆÙ„</label>
              <select id="conflict_subject_one" class="time-box">
                {% for subject in subject_list %}
                  <option value="{{ subject }}">{{ subject }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="button-container">
            <button onclick="addConflict()">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ¯Ø§Ø®Ù„</button>
          </div>

          <!-- Ø¬Ø¯ÙˆÙ„ ØªØ¯Ø§Ø®Ù„Ø§Øª -->
          <table id="conflicts-table">
            <thead>
              <tr>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                <th>ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø·Ø±Ù Ø´Ø¯Ù†</th>
                <th>Ù†ÙˆØ¹ ØªØ¯Ø§Ø®Ù„</th>
                <th>Ø±ÙˆØ² ØªØ¯Ø§Ø®Ù„</th>
                <th>Ø¯Ø±Ø³ Ø¯ÙˆÙ…</th>
                <th>Ø¯Ø±Ø³ Ø§ÙˆÙ„</th>
              </tr>
              <tr id="empty-conflicts-table">              
                <td colspan="6" style="text-align:center; color: black;">!Ù‡Ù†ÙˆØ² ØªØ¯Ø§Ø®Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
          <div class="button-container">
            <button onclick="saveConflicts()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª -->
    <div id="conflicts" class="tab-content">
      <!-- ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø®ÛŒØ± -->
      <div id="side_changes" class="section">
        <div class="add-change-box">
            <h3>ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø®ÛŒØ±</h3>
            <!-- ØªØºÛŒÛŒØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ -->
            <div id="change-messages">
            </div>
        </div>
      </div>

      <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
      <div class="add-message-box">
        <h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ</h3>
        <div class="messages-wrapper">
          <!-- Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ -->
          <div id="side_public" class="section">
            {% if full_name %}
              <div class="chat-container" id="publicChatContainer" style="display: block;">
                  <div class="chat-header">Ú†Øª Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ</div>
                  <div class="chat-box" id="public">
                      <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                  </div>
                  <div class="chat-input">
                      <div id="pickerContainerPublic">
                        <button id="togglePickerBtnPublic" style="font-size: 21px; padding-top: 3px; padding-bottom: 4px;">ğŸ˜Š</button>
                        <div id="emojiPickerPublic"></div>
                      </div>
                      <input type="text" id="messageInputPublic" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                      <button onclick="sendPublicMessage()">Ø§Ø±Ø³Ø§Ù„</button>
                  </div>
              </div>
            {% endif %}
          </div>

          <!-- Ú†Øª Ø®ØµÙˆØµÛŒ -->
          <div id="side_private" class="section">
            {% if full_name%}
              <div class="chat-container" id="privateChatContainer" style="display: block;">
                  <div class="chat-header"></div>
                  <div class="chat-box" id="private">
                      <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                  </div>
                  <div class="chat-input">
                      <div id="pickerContainerPrivate">
                        <button id="togglePickerBtnPrivate" style="font-size: 21px; padding-top: 3px; padding-bottom: 4px;">ğŸ˜Š</button>
                        <div id="emojiPickerPrivate"></div>
                      </div>
                      <input type="text" id="messageInputPrivate" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                      <button onclick="sendPrivateMessage()">Ø§Ø±Ø³Ø§Ù„</button>
                  </div>
              </div>
            {% endif %}
          </div>
          
          <div id="side_messages" class="section">
            <div id="contacts-list"><!-- Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ --></div>
          </div>
        </div>
      </div>
    <div>
  </div>
</body>
<script>
  let studentName = "{{ full_name }}";
  let studentMajor = "{{ major }}";
</script>
<script src="{% static 'js/student_script.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tbody = document.getElementById("weekly-schedule-body");
    const days = ["Ø´Ù†Ø¨Ù‡", "ÛŒÚ©Ø´Ù†Ø¨Ù‡", "Ø¯ÙˆØ´Ù†Ø¨Ù‡", "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡", "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡", "Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡"];
    const pad = n => n.toString().padStart(2, "0");

    days.forEach((day, dayIndex) => {
      const tr = document.createElement("tr");
      const dayCell = document.createElement("td");
      dayCell.textContent = day;
      tr.appendChild(dayCell);

      for (let i = 8; i < 18; i += 0.5) {
        const startHour = Math.floor(i);
        const startMin = i % 1 === 0 ? "00" : "30";
        const endHour = startMin === "00" ? startHour : startHour + 1;
        const endMin = startMin === "00" ? "30" : "00";
        const timeId = `day${dayIndex}-${pad(startHour)}:${startMin}-${pad(endHour)}:${endMin}`;

        const td = document.createElement("td");
        td.className = "time-block";
        td.id = timeId;
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });
  });
</script>
<script type="module">
  import { createPicker } from 'https://cdn.skypack.dev/picmo';

  // ==== Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ ====
  const pickerPublic = createPicker({
    rootElement: document.getElementById('emojiPickerPublic')
  });

  const toggleBtnPublic = document.getElementById('togglePickerBtnPublic');
  const inputPublic = document.getElementById('messageInputPublic');
  const pickerContainerPublic = document.getElementById('emojiPickerPublic');

  pickerContainerPublic.style.display = 'none';

  toggleBtnPublic.addEventListener('click', () => {
    pickerContainerPublic.style.display =
      pickerContainerPublic.style.display === 'none' ? 'block' : 'none';
  });

  pickerPublic.addEventListener('emoji:select', event => {
    inputPublic.value += event.emoji;
    inputPublic.focus();
  });

  // ==== Ú†Øª Ø®ØµÙˆØµÛŒ ====
  const pickerPrivate = createPicker({
    rootElement: document.getElementById('emojiPickerPrivate')
  });

  const toggleBtnPrivate = document.getElementById('togglePickerBtnPrivate');
  const inputPrivate = document.getElementById('messageInputPrivate');
  const pickerContainerPrivate = document.getElementById('emojiPickerPrivate');

  pickerContainerPrivate.style.display = 'none';

  toggleBtnPrivate.addEventListener('click', () => {
    pickerContainerPrivate.style.display =
      pickerContainerPrivate.style.display === 'none' ? 'block' : 'none';
  });

  pickerPrivate.addEventListener('emoji:select', event => {
    inputPrivate.value += event.emoji;
    inputPrivate.focus();
  });
</script>
</html>
